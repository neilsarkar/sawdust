<!DOCTYPE html>
<html>
<head>
  <title>Hello World</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- build:css -->
  <!-- endbuild -->
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
</head>

<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

  <div id='content'></div>
  <script type="text/jsx">
    function timeString(seconds) {
      var minutes = parseInt(seconds / 60),
          hours = parseInt(minutes / 60);

      if( hours ) {
        return pluralize(hours, "hour") + ", " + pluralize(minutes, "minute");
      } else if( minutes ) {
        return pluralize(minutes, "minute");
      } else {
        return seconds;
      }
    }

    function pluralize(amount, string) {
      return amount == 1 ? "1 " + string : amount + " " + string + "s";
    }


    var Task = React.createClass({
      getInitialState: function() {
        return({editing: true, name: "", seconds: 0})
      },

      componentWillUnmount: function() {
        if( this.timer ) { clearTimeout(this.timer); }
      },

      edit: function() {
        this.setState({editing: true, name: this.state.name})
      },

      keyup: function(e) {
        if( e.key == 'Enter' ) {
          var name = React.findDOMNode(this.refs.task).value;
          this.startTime = +new Date;
          this.trackTime();
          this.setState({name: name, editing: false});
        }
      },

      togglePause: function() {
        if( this.state.paused ) {
          this.startTime = +new Date;
          this.trackTime();
        } else {
          clearTimeout(this.timer);
        }
        this.setState({paused: !this.state.paused});
      },

      trackTime: function() {
        var now = +new Date;

        this.state.seconds += parseInt((now - this.startTime)/1000);
        this.setState({timeElapsed: timeString(this.state.seconds)});
        this.startTime = now;
        this.timer = setTimeout(this.trackTime, 1000);
      },

      render: function() {
        if( this.state.editing ) {
          return(
            <div className="task s-editing">
              <input ref="task" onKeyUp={this.keyup} placeholder="What do you have to do first?" />

            </div>
          )
        } else {
          return(
            <div className="task {this.state.paused ? 'paused' : ''}">
              <div className="name" onClick={this.edit}>{this.state.name}</div>
              <div className="time">{this.state.timeElapsed}</div>
              <a onClick={this.bail}>Bail</a> {' '}
              <a onClick={this.enter}>Enter</a> {' '}
              <a onClick={this.togglePause}>{this.state.paused ? 'Resume' : 'Pause'}</a>
            </div>
          )
        }
      }
    })

    React.render(
      <Task />,
      document.querySelector('#content')
    )
  </script>
  <!-- build:js -->
  <!-- endbuild -->
</body>
</html>
